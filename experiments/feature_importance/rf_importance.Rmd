<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Feature selection part 2 | fastpages</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Feature selection part 2" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A critique to feature importance" />
<meta property="og:description" content="A critique to feature importance" />
<link rel="canonical" href="https://david26694.github.io/david-masip-blog/experiments/feature_importance/rf_importance.Rmd" />
<meta property="og:url" content="https://david26694.github.io/david-masip-blog/experiments/feature_importance/rf_importance.Rmd" />
<meta property="og:site_name" content="fastpages" />
<script type="application/ld+json">
{"description":"A critique to feature importance","@type":"WebPage","headline":"Feature selection part 2","url":"https://david26694.github.io/david-masip-blog/experiments/feature_importance/rf_importance.Rmd","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/david-masip-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://david26694.github.io/david-masip-blog/feed.xml" title="fastpages" /><link rel="shortcut icon" type="image/x-icon" href="/david-masip-blog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Feature selection part 2 | fastpages</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Feature selection part 2" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A critique to feature importance" />
<meta property="og:description" content="A critique to feature importance" />
<link rel="canonical" href="https://david26694.github.io/david-masip-blog/experiments/feature_importance/rf_importance.Rmd" />
<meta property="og:url" content="https://david26694.github.io/david-masip-blog/experiments/feature_importance/rf_importance.Rmd" />
<meta property="og:site_name" content="fastpages" />
<script type="application/ld+json">
{"description":"A critique to feature importance","@type":"WebPage","headline":"Feature selection part 2","url":"https://david26694.github.io/david-masip-blog/experiments/feature_importance/rf_importance.Rmd","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://david26694.github.io/david-masip-blog/feed.xml" title="fastpages" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script type="text/javascript">
require.config({
  paths: {
    jquery: 'https://code.jquery.com/jquery-3.5.0.min',
    plotly: 'https://cdn.plot.ly/plotly-latest.min'
  },

  shim: {
    plotly: {
      deps: ['jquery'],
      exports: 'plotly'
    }
  }
});
</script>

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/david-masip-blog/">fastpages</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/david-masip-blog/about/">About Me</a><a class="page-link" href="/david-masip-blog/experiments/lasso/lasso_vs_corr.Rmd">Feature selection part 1</a><a class="page-link" href="/david-masip-blog/experiments/feature_importance/rf_importance.Rmd">Feature selection part 2</a><a class="page-link" href="/david-masip-blog/search/">Search</a><a class="page-link" href="/david-masip-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Feature selection part 2</h1><p class="page-description">A critique to feature importance</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="" itemprop="datePublished">
        
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/david-masip-blog/categories/#markdown">markdown</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    # Feature selection part 2: A critique to feature importance

In part 1, I showed some of the dangers of using univariate selection methods. In part 2 I want to focus on the pitfalls of feature importance in random forests and gradient boosting methods.

I'll write about it in the feature selection chapter as feature importances can be used to select features, [as in Sklearn SelectFromModel](https://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.SelectFromModel.html#sklearn.feature_selection.SelectFromModel).

In order to select features using feature importances, one can:

- Train a model that has allows to compute feature importances.
- Retrain the model with only the most important features.

In my experience, when retraining with only the most important features, the model usually degrades a little (this might not always happen).

The main issue regarding selecting features using feature importance is that, if a feature is highly correlated with others, its importance will be lower than if this doesn't happen.

As a rule of thumb, I'd say check that your features are not very correlated if you want to assess them using feature importance.

## Experiment set-up

In order to show the deficiencies of selecting features using feature importance, we'll use a rather ill-defined example. In this example, `x1`, `x2`, `x3` and `x4` are independent variables and the dependent variable is 
```
y = x1 + (x2 + x3 + x4) / 2 + noise
```
When training a random forest, `x1` should appear as the most important variable. If the feature selection method had to keep only one feature, `x1` should be the one to select.

To see an example where feature importance might mislead you, we've created some borthers to `x1`. These brothers are variables that are very correlated to `x1` and will be used to model `y` as well. These brothers are what cause the importance of `x1` to be diminished.

```{r message=FALSE, warning=FALSE, echo=FALSE}
# library(rmarkdown)
# render("experiments/feature_importance/rf_importance.Rmd", md_document(variant ='gfm', preserve_yaml=TRUE))
```
```{r message=FALSE, warning=FALSE}
library("dplyr")
library("randomForest")
library("glmnet")
library("yardstick")


set.seed(42)

len <- 5000

x1 <- rnorm(len)
x2 <- rnorm(len)
x3 <- rnorm(len)
x4 <- rnorm(len)

# The outcome is created without the brothers
y <- x1 + 0.5 * x2 + 0.5 * x3 + 0.5 * x4 + rnorm(len)

x11 <- 0.95 * x1 + 0.05 * rnorm(len)
x12 <- 0.95 * x1 + 0.05 * rnorm(len)
x13 <- 0.95 * x1 + 0.05 * rnorm(len)
x14 <- 0.95 * x1 + 0.05 * rnorm(len)
x15 <- 0.95 * x1 + 0.05 * rnorm(len)
x16 <- 0.95 * x1 + 0.05 * rnorm(len)
x17 <- 0.95 * x1 + 0.05 * rnorm(len)
x18 <- 0.95 * x1 + 0.05 * rnorm(len)

```

The table for the model is created, with `x1` to `x4`, as well as `x1`'s brothers.

```{r}
model_tbl <- tibble(
  y = y,
  x1 = x1,
  x2 = x2,
  x3 = x3,
  x4 = x4,
  x11 = x11,
  x12 = x12,
  x13 = x13,
  x14 = x14,
  x15 = x15,
  x16 = x16,
  x17 = x17,
  x18 = x18
)

X <- as.matrix(select(model_tbl, -y))
```

## Random forest importance

We'll train a random forest model (when training this model, it automatically computes feature importance)

```{r}
# Random forest importance ------------------------------------------------

rf <- randomForest(X, y, importance = T)
```

And we show the importance of the features

```{r}
varImpPlot(rf, type = 1)
```

This shows the shortcomings of feature importance: `x1` doesn't appear as the most important feature. If we were to select three variables, we would select `x2`, `x3` and `x4`, and this would of course degrade the model performance.

And if you think about it, it makes sense. In this random forest, to model the `x1` contribution, some splits are done with `x1`, some with her brothers. For this reason, if `x1` gets broken, the impact is not as big as if `x2` breaks.

### Lasso selection

On the other hand, lasso kind of makes it (recall that `cv.glmnet` default is lasso):

```{r}
# Train lasso
lasso <- cv.glmnet(X, y)

# Kind of makes it
coef(lasso, s = "lambda.min")
```

It selects some of the `x1` brothers, but with really small coefficients. If we regularize a bit more, they'll probably vanish.

In fact, the next figure shows that the last feature to be vanished is `x1`, which didn't happen in the random forest:

```{r}
# x1 is the last one to go
plotmo::plot_glmnet(lasso$glmnet.fit)
```



  </div><a class="u-url" href="/david-masip-blog/experiments/feature_importance/rf_importance.Rmd" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/david-masip-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/david-masip-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/david-masip-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fastai" title="fastai"><svg class="svg-icon grey"><use xlink:href="/david-masip-blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/david-masip-blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
